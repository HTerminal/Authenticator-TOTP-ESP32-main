# Hardware Authenticator for Phone-Free TOTP

Many people want to use two-factor authentication but don't want to rely on their phones for security codes. This project lets you generate TOTP codes on an ESP32, so you can stay secure without needing a smartphone authenticator app.

# ESP32 TOTP Generator (Time-based One-Time Password)

This project generates a 6-digit TOTP code on an ESP32 using a shared secret and the current time from an NTP server (UTC). The code matches the output of Python and standard authenticator apps.

## How it works (line-by-line explanation)

1. **Include Libraries**
   - `#include <Arduino.h>`: Core Arduino functions.
   - `#include <WiFi.h>`: For WiFi connection.
   - `#include <time.h>`: For time functions.
   - `#include <mbedtls/md.h>`: For HMAC-SHA1 calculation.
   - `#include <NTPClient.h>`: For getting time from an NTP server.
   - `#include <WiFiUdp.h>`: For UDP communication (used by NTPClient).

2. **Secret Setup**
   - `const char* secret32 = "WPHR3VQGVNGRICXN";`: The shared Base32-encoded secret for TOTP.

3. **Base32 Decode Function**
   - Decodes the Base32 secret into bytes for use in HMAC.

4. **Pack Time Function**
   - Packs the time counter into 8 bytes (big-endian) as required by the TOTP algorithm.

5. **Dynamic Truncate Function**
   - Extracts a 6-digit code from the HMAC result, per the TOTP standard.

6. **WiFi Credentials**
   - Set your WiFi SSID and password.

7. **NTP Client Setup**
   - `WiFiUDP ntpUDP;` and `NTPClient timeClient(ntpUDP, "pool.ntp.org", 0, 60000);`: Sets up NTP client for UTC time.

8. **setup() Function**
   - Starts serial communication.
   - Connects to WiFi and waits until connected.
   - Starts the NTP client and gets the current time.

9. **loop() Function**
   - Updates the NTP time.
   - Gets the current epoch time (seconds since 1970-01-01 UTC).
   - Calculates the TOTP counter (epoch time divided by 30 seconds).
   - Decodes the Base32 secret.
   - Packs the counter into 8 bytes.
   - Calculates the HMAC-SHA1 of the secret and counter.
   - Applies dynamic truncation to get a 6-digit TOTP code.
   - Prints the UTC time, epoch, counter, and TOTP code to the serial monitor.
   - Waits 1 second and repeats.

## Usage
1. Set your WiFi credentials in the code.
2. Upload the code to your ESP32.
3. Open the Serial Monitor at 115200 baud.
4. The ESP32 will print a new TOTP code every 30 seconds, along with the current UTC time and counter.

## Notes
- The TOTP code will match codes generated by Python or authenticator apps if the secret and time are the same.
- The code uses UTC for time calculations to ensure compatibility across platforms.

## TOTP Formula and Details

### What is TOTP?
TOTP (Time-based One-Time Password) is a standard algorithm (RFC 6238) used to generate a 6-digit code that changes every 30 seconds. It is widely used for two-factor authentication (2FA) in apps like Google Authenticator.

### How does it work?
1. **Shared Secret**: Both the server and device (ESP32) share a secret key (in Base32 format).
2. **Time Counter**: The current Unix time (seconds since 1970-01-01 UTC) is divided by 30 to get a time step (counter).
3. **HMAC-SHA1**: The secret and the packed counter are used to compute an HMAC-SHA1 hash.
4. **Dynamic Truncation**: A specific part of the hash is extracted to get a 31-bit integer.
5. **6-digit Code**: The integer is reduced modulo 1,000,000 to get a 6-digit code.

### TOTP Formula
- **Counter**: `counter = floor(current_unix_time / 30)`
- **Packed Counter**: 8-byte big-endian representation of the counter
- **HMAC**: `HMAC-SHA1(secret, packed_counter)`
- **Dynamic Truncation**:
  - Offset = last nibble of HMAC (`hmac[19] & 0x0F`)
  - Extract 4 bytes from HMAC starting at offset
  - Convert to 31-bit integer
- **TOTP Code**: `code = (truncated_value) % 1000000`

### Example
If the current Unix time is 1748855469:
- Counter = 1748855469 // 30 = 58295182
- Packed Counter = `b'\x00\x00\x00\x00\x03y\x83\x8e'`
- HMAC = result of HMAC-SHA1(secret, packed_counter)
- Offset = HMAC[19] & 0x0F
- Truncated value = 31 bits from HMAC at offset
- TOTP = truncated_value % 1000000 (e.g., 763238)

### Security Notes
- The secret must be kept private.
- The code is only valid for 30 seconds.
- If the time or secret is not in sync, the code will not match.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.

---

This project is useful for building your own hardware authenticator or for learning how TOTP works on embedded devices.
